<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>eXdpn - {{log.name}}</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0-beta1/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-0evHe/X+R7YkIZDRvuzKMRqM+OrBnVFBL6DOitfPri4tjfHxaWutUpFmBp4vmVor"
      crossorigin="anonymous"
    />
    <link rel="shortcut icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
    <script src="https://unpkg.com/@hpcc-js/wasm/dist/index.min.js"></script>
    <script src="https://unpkg.com/d3-graphviz/build/d3-graphviz.js"></script>
  </head>

  <body>
    <script>
      let logAttributes = null;

      let decisionMined = false;

      let selectedPlace = null;

      let livePredictions = null;

      let guardDataPerPlace = {};
      function loadEventLog() {
        fetch("/log/{{log_id}}/load", {
          method: "GET",
        })
          .then(async (res) => {
            if (res.ok) {
              const logInfo = await res.json();
              for (const key in logInfo["xes_stats"]) {
                document.getElementById(key).innerHTML =
                  logInfo["xes_stats"][key];
              }
              logAttributes = logInfo["attributes"];
              for (const attributeType in logAttributes) {
                const el = document.getElementById(attributeType);
                if (logAttributes[attributeType].length > 0) {
                  el.innerHTML = "";
                  for (const attribute of logAttributes[attributeType]) {
                    const label = document.createElement("label");
                    label.classList.add("list-group-item");

                    const input = document.createElement("input");
                    input.classList.add("form-check-input", "me-2");
                    input.type = "checkbox";
                    input.dataset.attributeName = attribute;
                    label.appendChild(input);
                    const labelText = document.createElement("samp");
                    labelText.textContent = attribute;
                    label.appendChild(labelText);
                    el.appendChild(label);
                  }
                }
              }

            }else{
              const errorMessage = await getErrorMessageFromRes(res);
              showErrorToast(errorMessage)
            }
            document
              .querySelectorAll("#discoverModelButtons > button")
              .forEach((button) => {
                button.removeAttribute("disabled");
              });
          })
          .catch((err) => {
            showErrorToast(err)
            document
              .querySelectorAll("#discoverModelButtons > button")
              .forEach((button) => {
                button.removeAttribute("disabled");
          })
          });
      }

      function loadPetriNet(algoName) {
        decisionMined = false;
        document.getElementById('meanGuardConformance').style.display = 'none';
        console.log("Loading Petri net for {{log_id}}...");
        fetch("/log/{{log_id}}/discover/" + algoName, {
          method: "GET",
        })
          .then(async (res) => {
            if (res.ok) {
              const net = await res.json();
              d3.select("#discoveredPetriNet")
                .graphviz()
                .width("100%")
                .fit(true)
                .renderDot(net.dot, () => {
                  document.querySelectorAll("g.node").forEach((n) => {
                    let title = n.querySelector("title");
                    if (
                      title &&
                      net.decision_points.indexOf(title.textContent) > -1
                    ) {
                      let ellipse = n.querySelector("ellipse");
                      if (ellipse) {
                        ellipse.classList.add("decisionPlace");
                        ellipse.addEventListener("click", (e) => {
                          if(decisionMined){
                            const placeId = title.textContent;
                            selectedPlace = placeId;

                            // Show data for selected place & guard
                            document.getElementById('selected_guard_name').textContent = guardDataPerPlace[placeId]['name']
                            document.getElementById('selected_guard_performance').textContent = Math.round(parseFloat(guardDataPerPlace[placeId]['performance'])*100)/100;
                            // document.getElementById('selected_guard_svg').setAttribute('src', guardDataPerPlace[placeId]['svg_url'])
                            // document.getElementById('selected_guard_global_svg').removeAttribute('src');
                            
                            document.getElementById('selected_guard_comparison_svg').setAttribute('src',guardDataPerPlace[placeId]['comparison_svg_url'])
                            
                            let element_str = `<select class="form-select mb-1" aria-label="Choose Explainable Representation" name="ML Technique" id="expl-repr-selector">`;
                            for(const technique of guardDataPerPlace[placeId]['techniques']){
                              element_str += `<option value="${technique}" ${guardDataPerPlace[placeId]['name'] === technique ? 'selected' : ''}>${technique}</option>`;
                            }
                            element_str += "</select>";
                            document.getElementById("selector-container").innerHTML = element_str;
                            selector = document.getElementById("expl-repr-selector")
                            selector.removeAttribute('disabled');
                            document.getElementById("decisionMiningWarningText").innerText = guardDataPerPlace[placeId]['warning_text'];
                            const selectSpinner = document.getElementById("selector-container-spinner");
                            selectSpinner.style.display = 'none';
                            selector.addEventListener("input", (e) => {
                              getExplainableRepresentation(selector.value, placeId)
                            })


                            // document.getElementById('local-instance-selector-container')
                            let local_technique_selector_str = `<select class="form-select mb-1" aria-label="Choose Explainable Representation" name="ML Technique" id="local-technique-selector">`;
                            for(const technique of guardDataPerPlace[placeId]['techniques']){
                              local_technique_selector_str += `<option value="${technique}" ${guardDataPerPlace[placeId]['name'] === technique ? 'selected' : ''}>${technique}</option>`;
                            }
                            local_technique_selector_str += "</select>";
                            document.getElementById('local-technique-selector-container').innerHTML = local_technique_selector_str;
                            let localTechniqueSelector = document.getElementById('local-technique-selector')
                            localTechniqueSelector.removeAttribute('disabled')
                            localTechniqueSelector.addEventListener("input", (e) => {
                              if(document.getElementById('local-explanation-log-type').value === 'live'){
                                getLocalExplanation(localTechniqueSelector.value, placeId, liveLocalInstanceSelector.value, true);
                              }else{
                                getLocalExplanation(localTechniqueSelector.value, placeId, localInstanceSelector.value, false);
                              }
                            })

                            document.getElementById('local-explanation-log-type').oninput =  (e) => {
                                  let toShow;
                                  let toHide
                                  if(event.currentTarget.value === 'normal'){
                                    toHide = document.querySelector("#live-local-instance-selector-container")
                                    toShow = document.querySelector("#local-instance-selector-container")
                                    getLocalExplanation(localTechniqueSelector.value, placeId, localInstanceSelector.value, false);
                                  }else{
                                    toShow = document.querySelector("#live-local-instance-selector-container")
                                    toHide = document.querySelector("#local-instance-selector-container")
                                    getLocalExplanation(localTechniqueSelector.value, placeId, liveLocalInstanceSelector.value, true);
                                  }
                                  toShow.style = 'display: block';
                                  toHide.style = 'display: none';
                            }


                            let local_instance_selector_str = `<select class="form-select mb-1" aria-label="Choose Instance" name="Instance" id="local-instance-selector">`;
                            for(const instance of guardDataPerPlace[placeId]['instances']){
                              local_instance_selector_str += `<option value="${instance[0]}/${instance[1]}">${instance[0]} - ${instance[1]}</option>`;
                            }
                            local_instance_selector_str += "</select>";
                            document.getElementById('local-instance-selector-container').innerHTML = local_instance_selector_str;
                            let localInstanceSelector = document.getElementById('local-instance-selector')
                            localInstanceSelector.removeAttribute('disabled')
                            localInstanceSelector.addEventListener("input", (e) => {
                              if(document.getElementById('local-explanation-log-type').value === 'live'){
                                getLocalExplanation(localTechniqueSelector.value, placeId, liveLocalInstanceSelector.value, true);
                              }else{
                                getLocalExplanation(localTechniqueSelector.value, placeId, localInstanceSelector.value, false);
                              }
                            })

                            let live_local_instance_selector_str = `<select class="form-select mb-1" aria-label="Choose Instance" name="Instance" id="live-local-instance-selector">`;
                              for(const instance in (livePredictions ? livePredictions[placeId] : {})){
                                live_local_instance_selector_str += `<option value="${instance}">${instance}</option>`;
                              }
                              live_local_instance_selector_str += "</select>";
                              document.getElementById('live-local-instance-selector-container').innerHTML = live_local_instance_selector_str;
                              let liveLocalInstanceSelector = document.getElementById('live-local-instance-selector')
                              liveLocalInstanceSelector.removeAttribute('disabled')
                              liveLocalInstanceSelector.addEventListener("input", (e) => {
                                if(document.getElementById('local-explanation-log-type').value === 'live'){
                                  getLocalExplanation(localTechniqueSelector.value, placeId, liveLocalInstanceSelector.value, true);
                                }else{
                                  getLocalExplanation(localTechniqueSelector.value, placeId, localInstanceSelector.value, false);
                                }
                              })

                            document.getElementById('selected_guard_local_svg').removeAttribute('src');

                            
                            handleGlobalExplanation(guardDataPerPlace[placeId]['svg_representations'])
                            const firstInstance = guardDataPerPlace[placeId]['instances'][0];
                            getLocalExplanation(guardDataPerPlace[placeId]['name'], placeId, firstInstance[0] + "/" + firstInstance[1]);

                            const bsel = new bootstrap.Offcanvas('#offcanvasScrolling')
                            bsel.show();
                            console.log(title.textContent)
                          }
                        });
                      }
                    }
                  });
                  document.getElementById("chooseAttributes").style.display =
                    "block";
                });
            } else{
              const errorMessage = await getErrorMessageFromRes(res);
              showErrorToast(errorMessage)
            }
          })
          .catch((err) => {
            showErrorToast(err)
          });
      }


      async function getErrorMessageFromRes(res){
        try{
          const json = await res.json();
          if('message' in json){
            return json['message'];
          }else{
            return res.statusText;
          }
        }catch(e){
            return res.statusText;
        }
      }

      function showErrorToast(message){
            const toast_elem = document.getElementById("errorToast")
            const toast = new bootstrap.Toast(toast_elem)

            toast_elem.querySelector(".toast-body").innerText = message

            toast.show()
      }

      function getSelectedAttributes(){
        let selectedAttributes = {};
        for(const attributeType in logAttributes){
          const el = document.getElementById(attributeType);
          const attributeNames = [...el.querySelectorAll('input:checked')].map(e => e.dataset.attributeName);

          selectedAttributes[attributeType] = attributeNames;
        }
        const synEl = document.getElementById('synthetic_attributes');
        const synthAttributes = [...synEl.querySelectorAll('input:checked')].map((e) => e.dataset.synthName)
        selectedAttributes['synthetic_attributes'] = synthAttributes;

        const mlEl = document.getElementById('ml_techniques');
        const selectedMLs = [...mlEl.querySelectorAll('input:checked')].map((e) => e.dataset.mlName)
        selectedAttributes['ml_techniques'] = selectedMLs;
        return selectedAttributes;
      }



      function mineDecisions(){ 
        let selectedAttributes = getSelectedAttributes()
        
        if (selectedAttributes["ml_techniques"].length === 0) {
          showErrorToast("No ML Techniques Selected")
          return
        }
        
        let loadDecisionButton = document.getElementById('mine-decisions-btn');
        let loadDecisionButtonLoadingSpan = document.querySelector('#mine-decisions-btn > span.spinner-border');
        loadDecisionButton.setAttribute('disabled',"");
        loadDecisionButtonLoadingSpan.style.display = 'inline-block';

        fetch('/log/{{log_id}}/mine-decisions', {method: 'POST', body: JSON.stringify(selectedAttributes),headers: {'Content-Type': 'application/json'}, }).then(async (res) => {
          if(res.ok){
            const json = await res.json();
            console.log({json},'mine-decision result json')
            decisionMined = true;
          loadDecisionButton.removeAttribute('disabled'); // do we want to do that?
          loadDecisionButtonLoadingSpan.style.display = 'none';
          document.getElementById('meanGuardConformanceValue').innerText = Math.round(json['mean_guard_conformance'] * 100)/100;
          
          document.getElementById('meanGuardConformance').style.display = 'block';
          guardDataPerPlace = json['place_info'];
          for(const placeId in guardDataPerPlace){
            let firstSvgKey;
            for(const plotName in guardDataPerPlace[placeId]['svg_representations']){
              if(guardDataPerPlace[placeId]['svg_representations'][plotName].type === 'svg' && firstSvgKey == undefined){
                firstSvgKey = plotName;
              }
            }

            handleGlobalExplanation(guardDataPerPlace[placeId]['svg_representations'])

            const blob = new Blob([guardDataPerPlace[placeId]['svg_representations'][firstSvgKey].data],{type: 'image/svg+xml'})
            const url = URL.createObjectURL(blob);
            guardDataPerPlace[placeId]['svg_url'] = url;

            const resultsComparisonBlob = new Blob([guardDataPerPlace[placeId]['guard_result_svg']],{type: 'image/svg+xml'})
            const resultsComparisonUrl = URL.createObjectURL(resultsComparisonBlob);
            guardDataPerPlace[placeId]['comparison_svg_url'] = resultsComparisonUrl;
            console.log({guardDataPerPlace})
          }
        }else{
          loadDecisionButton.removeAttribute('disabled');
          loadDecisionButtonLoadingSpan.style.display = 'none';
          const errorMessage = await getErrorMessageFromRes(res);
          showErrorToast(errorMessage)
        }
        }).catch((err) => {
          console.error({err})
          loadDecisionButton.removeAttribute('disabled');
          loadDecisionButtonLoadingSpan.style.display = 'none';
            showErrorToast(err)
        })
      }

      document.addEventListener("DOMContentLoaded", (ev) => {
        loadEventLog();
      });



      function handleGlobalExplanation(svg_representations){
        console.log("Handle Global Explanation",{svg_representations})
        let explanation_option_selector_str = `<select class="form-select mb-1" aria-label="Choose Plot" name="Plot" id="global-explanation-option-selector">`;
        let isFirst = true;
        let initialRepresentation;
        for(const representation in svg_representations){
          explanation_option_selector_str += `<option value="${representation}" ${isFirst ? 'selected' : ''}>${representation}</option>`;
          if(isFirst){
            initialRepresentation = representation;
            isFirst = false;
          }
        }
        explanation_option_selector_str += "</select>";
        document.getElementById('global-explanation-options-container').innerHTML = explanation_option_selector_str;
        let globalExplanationOptionSelector = document.getElementById('global-explanation-option-selector')
        globalExplanationOptionSelector.removeAttribute('disabled')

        const handleChangedPlotName = () => {
          console.log(globalExplanationOptionSelector.value)
          if(svg_representations[globalExplanationOptionSelector.value].type === 'svg'){

            const blob = new Blob([svg_representations[globalExplanationOptionSelector.value].data],{type: 'image/svg+xml'})
            const blob_url = URL.createObjectURL(blob);
            document.getElementById('selected_guard_global_svg').setAttribute('src', blob_url);
            document.getElementById('selected_guard_global_svg').classList.remove('visually-hidden');
            document.getElementById('selected_guard_global_html').setAttribute('data', '');
            document.getElementById('selected_guard_global_html').classList.add('visually-hidden');
          }else{
            const blob = new Blob(["<!DOCTYPE html>\n" + svg_representations[globalExplanationOptionSelector.value].data],{type: 'text/html'})
            const blob_url = URL.createObjectURL(blob);
            document.getElementById('selected_guard_global_svg').removeAttribute('src');
            document.getElementById('selected_guard_global_svg').classList.add('visually-hidden');
            document.getElementById('selected_guard_global_html').classList.remove('visually-hidden');
            document.getElementById('selected_guard_global_html').setAttribute('data', blob_url);
          }
        };
        globalExplanationOptionSelector.addEventListener("input", handleChangedPlotName )

        handleChangedPlotName()
        // const blob = new Blob([svg_representations[initialRepresentation].data],{type: 'image/svg+xml'})
        // const blob_url = URL.createObjectURL(blob);
        // document.getElementById('selected_guard_global_svg').setAttribute('src', blob_url);
      }

      function getExplainableRepresentation(technique, placeid){
        const select = document.getElementById("expl-repr-selector");
        const select2 = document.getElementById("global-explanation-option-selector")
        if(select2){
          select2.setAttribute('disabled',"")
        }
        select.setAttribute('disabled',"");
        const selectSpinner = document.getElementById("selector-container-spinner");
        selectSpinner.style.display = 'block';
        fetch(`/log/{{log_id}}/place/${placeid}/explainable-representation/${technique}`, {
          method: "GET"
        }).then(async (res) => {
          if(res.ok){

            const json = await res.json();
            if(selectedPlace == placeid){
              handleGlobalExplanation(json['svg_representations'])
              // const blob = new Blob([json['svg_representatiosn']],{type: 'image/svg+xml'})
              // const blob_url = URL.createObjectURL(blob);
              // document.getElementById('selected_guard_svg').setAttribute('src', blob_url);
            }
          }else{
            const errorMessage = await getErrorMessageFromRes(res);
            showErrorToast(errorMessage)
          }
          select.removeAttribute('disabled');
          selectSpinner.style.display = 'none';
        }).catch((err) => {
          console.log({err});
          select.removeAttribute('disabled');
          if(select2){
          select2.removeAttribute('disabled')
        }
          selectSpinner.style.display = 'none';
          showErrorToast(err)
        });
      }

      function getLocalExplanation(technique, placeid, caseAndRepetition, isLive = false){
        const select = document.getElementById("local-technique-selector");
        select.setAttribute('disabled',"");
        const select2 = document.getElementById("local-instance-selector");
        select2.setAttribute('disabled',"");
        const select4 = document.getElementById("live-local-instance-selector");
        select4.setAttribute('disabled',"");
        const select5 = document.getElementById("local-explanation-log-type");
        select5.setAttribute('disabled',"");
        const select3 = document.getElementById("local-explanation-option-selector");
        if (select3) {
          select3.setAttribute('disabled',"");
        }

        const selectSpinner = document.getElementById("local-selector-container-spinner");
        selectSpinner.style.display = 'block';

        const url = isLive ? `/log/{{log_id}}/place/${placeid}/live-local-explanation/${technique}/case/${caseAndRepetition}` : `/log/{{log_id}}/place/${placeid}/explainable-representation/${technique}/local/${caseAndRepetition}`

        fetch(url, {
          method: "GET"
        }).then(async (res) => {
          if(res.ok){
            const json = await res.json();
            if(selectedPlace == placeid){
              
              let explanation_option_selector_str = `<select class="form-select mb-1" aria-label="Choose Plot" name="Plot" id="local-explanation-option-selector">`;
              let isFirst = true;
              let initialRepresentation;
              if(isLive && 'prediction' in json){
                document.getElementById('live-local-prediction').innerText = 'Predicted: ' + json['prediction']
              }else{
                document.getElementById('live-local-prediction').innerText = ''
              }
              for(const representation in json['svg_representations']){
                explanation_option_selector_str += `<option value="${representation}" ${isFirst ? 'selected' : ''}>${representation}</option>`;
                if(isFirst){
                  initialRepresentation = representation;
                  isFirst = false;
                }
              }
              explanation_option_selector_str += "</select>";
              document.getElementById('local-explanation-options-container').innerHTML = explanation_option_selector_str;
              let localExplanationOptionSelector = document.getElementById('local-explanation-option-selector')
              localExplanationOptionSelector.removeAttribute('disabled')
              localExplanationOptionSelector.addEventListener("input", (e) => {
                console.log(localExplanationOptionSelector.value)

                const blob = new Blob([json['svg_representations'][localExplanationOptionSelector.value]],{type: 'image/svg+xml'})
                const blob_url = URL.createObjectURL(blob);
                document.getElementById('selected_guard_local_svg').setAttribute('src', blob_url);
              })

              const blob = new Blob([json['svg_representations'][initialRepresentation]],{type: 'image/svg+xml'})
              const blob_url = URL.createObjectURL(blob);
              document.getElementById('selected_guard_local_svg').setAttribute('src', blob_url);
            }
          }else{
            const errorMessage = await getErrorMessageFromRes(res);
            showErrorToast(errorMessage)
          }
        }).catch((err) => {
          console.log({err});
          showErrorToast(err)
        }).finally(() => {
          select.removeAttribute('disabled');
          select2.removeAttribute('disabled');
          select4.removeAttribute('disabled');
          select5.removeAttribute('disabled');
          if(select3){
            select3.removeAttribute('disabled');
          }
          selectSpinner.style.display = 'none';
        });
      }

      function onSubmitLiveEventLogForm(e){
        e.preventDefault();
        const fileInput = document.querySelector('#live-event-log-form input');
        const formData = new FormData()
        formData.append('log',fileInput.files[0])
        const modal = bootstrap.Modal.getOrCreateInstance(document.getElementById('uploadLiveLogModal'))
        if(modal){
          modal.hide();
        }

        
        fetch('/log/{{log_id}}/load-live-log',{body: formData, method: 'POST', }).then(async (res) => {
          const bsel = bootstrap.Offcanvas.getInstance(document.getElementById('offcanvasScrolling'))
          if(bsel){
            bsel.hide();
          }
          const json = await res.json()
          livePredictions = json;
          console.log('live event log loaded',res);
          const logtype_selector = document.querySelectorAll('#local-explanation-log-type > option')
          for(const select of logtype_selector){
            select.removeAttribute('disabled')
          }
        }).catch((e) => {
          showErrorToast("Loading live event log failed!")
          console.log('live event log failed',e);
        })
      }
    </script>
    <style>
      .offcanvasGrid {
        gap: 5px;
        display: grid;
        grid-template-columns: 1fr 2fr 2fr;
      }
      #explainable_representation {
        height: 100%;
      }
      .offcanvas {
        --bs-offcanvas-height: max(50vh,400px) !important;
      }
      #discoveredPetriNet svg {
        border: 2px dashed rgba(49, 47, 47, 0.685);
      }

      .decisionPlace {
        fill: rgba(233, 64, 64, 0.514);
      }
      .decisionPlace:hover {
        fill: rgba(236, 27, 27, 0.761);
      }
      .decisionPlace.selectedPlace {
        fill: rgba(0, 128, 0, 0.514);
      }
      .decisionPlace.selectedPlace:hover {
        fill: rgba(0, 128, 0, 0.761);
      }
      img {
        max-height: 100%;
        max-width: 100%;
        height: max(33vh ,250px);
        margin: auto;
        object-fit: contain;
      }
      .explanation_height {
        height: max(33vh ,250px);
      }
    </style>

    <div class="container mt-2">
      <div class="d-flex w-100 justify-content-around align-items-center gap-2">
        <a href=".." class="link-primary">Back</a>
        <a href="https://aarkue.github.io/eXdpn/exdpn.html#user-guide" style="float: right;">User Guide</a>
        <button
        class="btn btn-secondary" data-bs-toggle="modal"
        data-bs-target="#uploadLiveLogModal">Load a Live Event Log</button>
      </div>
      <h1 class="text-center mb-5">eXdpn: {{log.name}}</h1>
      <div class="text-center">
        <div id="logInfo">
          <table class="table mt-3">
            <thead class="table-primary">
              <tr>
                <th scope="col">Event Log</th>
                <th scope="col">Number of unique activities</th>
                <th scope="col">Number of cases</th>
                <th scope="col">Number of events</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <th scope="row">{{log.name}}</th>
                <td id="num_activities">
                  <div
                    class="spinner-border spinner-border-sm text-secondary"
                    role="status"
                  >
                    <span class="visually-hidden">Loading...</span>
                  </div>
                </td>
                <td id="num_cases">
                  <div
                    class="spinner-border spinner-border-sm text-secondary"
                    role="status"
                  >
                    <span class="visually-hidden">Loading...</span>
                  </div>
                </td>
                <td id="num_events">
                  <div
                    class="spinner-border spinner-border-sm text-secondary"
                    role="status"
                  >
                    <span class="visually-hidden">Loading...</span>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
      <br />
      <div class="text-center">
        <div class="btn-group" id="discoverModelButtons">
          <!-- Default Button -->
          <button
            type="button"
            class="btn btn-primary"
            onClick="loadPetriNet('inductive_miner')"
            disabled
          >
            <b>Discover Model</b><br />
            with Inductive Miner
          </button>
          <!-- Dropdown for additional Discovery Algorithms -->
          <button
            type="button"
            style="background-color: #0e5bce"
            class="btn btn-primary dropdown-toggle dropdown-toggle-split"
            data-bs-toggle="dropdown"
            aria-expanded="false"
            disabled
          >
            <span class="visually-hidden">Toggle Dropdown</span>
          </button>
          <ul class="dropdown-menu">
            <li>
              <button
                class="dropdown-item"
                onclick="loadPetriNet('inductive_miner')"
              >
                with Inductive Miner
              </button>
            </li>
            <li>
              <button
                class="dropdown-item"
                onclick="loadPetriNet('alpha_miner')"
              >
                with Alpha Miner
              </button>
            </li>
          </ul>
        </div>
      </div>
      <div style="position: relative;">
        <div id="discoveredPetriNet" class="text-center mt-3"></div>
        <span style="position: absolute; top: 0.5rem; right: 0.5rem; display: none;"  id="meanGuardConformance">Mean guard conformance: <span id="meanGuardConformanceValue"></span></span>
      </div>
      <div id="chooseAttributes" style="display: none;">
          <h2 class="mt-4">Configure Decision Mining</h2>
          <div class="accordion" id="accordionExample">
            <div class="accordion-item">
              <div class="accordion-item">
                <h2 class="accordion-header" id="headingTwo">
                  <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne" aria-expanded="false" aria-controls="collapseOne">
                    Machine Learning Techniques
                  </button>
                </h2>
                <div id="collapseOne" class="accordion-collapse collapse" aria-labelledby="headingTwo">
                  <div class="accordion-body">
                    <div class="list-group" id="ml_techniques">
                      <label class="list-group-item">
                        <input type="checkbox" data-ml-name="Decision Tree"  class="form-check-input me-2" checked>
                        <samp>Decision Tree</samp>
                      </label>
                      <label class="list-group-item">
                        <input type="checkbox" data-ml-name="Logistic Regression"  class="form-check-input me-2" checked>
                        <samp>Logistic Regression</samp>
                      </label>
                      <label class="list-group-item">
                        <input type="checkbox" data-ml-name="Support Vector Machine"  class="form-check-input me-2" checked>
                        <samp>SVM</samp>
                      </label>
                      <label class="list-group-item">
                        <input type="checkbox" data-ml-name="Neural Network"  class="form-check-input me-2" checked>
                        <samp>Neural Network</samp>
                      </label>
                      <label class="list-group-item">
                        <input type="checkbox" data-ml-name="XGBoost"  class="form-check-input me-2" checked>
                        <samp>XGBoost</samp>
                      </label>
                      <label class="list-group-item">
                        <input type="checkbox" data-ml-name="Random Forest"  class="form-check-input me-2" checked>
                        <samp>Random Forest</samp>
                      </label>
                  </div>
                   </div>
                </div>
              </div>
            </div>
            <div class="accordion-item">
              <h2 class="accordion-header" id="headingTwo">
                <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
                  Considered Attributes
                </button>
              </h2>
              <div id="collapseTwo" class="accordion-collapse collapse show" aria-labelledby="headingTwo">
                <div class="accordion-body">
                  <div class="row mt-2">
                    <div class="col">
                      <h3 class="text-center">Case attributes</h3>
                      <div class="list-group" id="case_attributes">
                        <span class="text-center text-muted">
                          No case attributes present in log.
                        </span>
                      </div>
                    </div>
          
                    <div class="col">
                      <h3 class="text-center">Event attributes</h3>
                      <div class="list-group" id="event_attributes">
                        <span class="text-center text-muted">
                          No event attributes present in log.
                        </span>
                      </div>
                    </div>
          
                    <div class="col">
                      <h3 class="text-center">Synthetic attributes</h3>
                      <div class="list-group" id="synthetic_attributes">
                          <label class="list-group-item">
                            <input type="checkbox" data-synth-name="total_elapsed_time"  class="form-check-input me-2">
                            <samp>Elapsed time in case
                              <span class="text-muted">(per Event)</span>
                            </samp>
                          </label>
                          <label class="list-group-item">
                            <input type="checkbox" data-synth-name="time_since_last" class="form-check-input me-2">
                            <samp>Time since last event
                              <span class="text-muted">(per Event)</span>
                            </samp>
                          </label>
                      </div>
                    </div>
                </div>
                 </div>
              </div>
            </div>
          </div>
        <div class="text-center my-2">
          <button id="mine-decisions-btn" class="btn btn-primary btn-lg" onclick="mineDecisions()" type="button">
            <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true" style="display: none"></span>
            Mine Decisions
          </button>

        </div>
        <div class="offcanvas offcanvas-bottom" data-bs-scroll="true" data-bs-backdrop="false" tabindex="-1" id="offcanvasScrolling" aria-labelledby="offcanvasScrollingLabel">
          <div class="offcanvas-header align-items-start">
            <div  style="width: 100%;" class="offcanvasGrid">
              <div style="width: 100%;">
                <h4 class="text-muted">Best Technique: <span id="selected_guard_name" class="text-success">No name</span></h4>
                <p class="text-muted fs-5">F1 Score: <span id="selected_guard_performance" class="text-success"></span></p>
            <span id="decisionMiningWarningText" style="color: #a84040;"></span>
              </div>
              <div style="width: 100%;">
                <h4 class="text-center">Local Explanation</h4>
                <div class="d-flex justify-content-center align-items-center gap-2">
                  <div>
                    <select class="form-select mb-1" aria-label="Choose Instance" name="Instance" id="local-explanation-log-type">
                      <option value="normal">Normal Log</option>
                      <option disabled value="live">Live Log</option>
                    </select>
                  </div>
                  <div id="local-technique-selector-container">
                    <!-- Content Generated when DPN is mined and returned -->
                  </div>
                  <div id="local-instance-selector-container">
                    <!-- Content Generated when DPN is mined and returned -->
                  </div>
                  <div id="live-local-instance-selector-container" style="display: none">
                    <!-- Content Generated when Live Log is uploaded and results returned -->
                  </div>
                  <div id="local-explanation-options-container">
                    <!-- Content Generated when DPN is mined and returned -->
                  </div>
                  <div id="local-selector-container-spinner"
                  class="spinner-border spinner-border-sm text-secondary"
                  role="status"
                  style="display: none; width: 1.5rem; height: 1.5rem;"
                  >
                  <span class="visually-hidden">Loading...</span>
                </div>
              </div>
              </div>
              <div style="width: 100%;">
              <h4 class="text-center">Global Explanation</h4>
              <div class="d-flex justify-content-center align-items-center gap-2">
                <div id="selector-container">
                  <!-- Content Generated when DPN is mined and returned -->
                </div>

                <div id="global-explanation-options-container">
                  <!-- Content Generated when DPN is mined and returned -->
                </div>
                <div id="selector-container-spinner"
                class="spinner-border spinner-border-sm text-secondary"
                role="status"
                style="display: none; width: 1.5rem; height: 1.5rem;"
                >
                <span class="visually-hidden">Loading...</span>
              </div>
            </div>
            </div>
            </div>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
          </div>
          <div class="offcanvas-body">
            <div id="explainable_representation" class="offcanvasGrid" >
              <!-- <div class="h-100"> -->
                <img id="selected_guard_comparison_svg"/>
              <!-- </div> -->
              <div class="">
                <h5 class="text-center" id="live-local-prediction"></h5>
                <img id="selected_guard_local_svg" />
              </div>
              <!-- <div class="h-100"> -->
                <div class="explanation_height">
                  <object type="text/html" class="w-100 h-100" id="selected_guard_global_html"></object>
                  <!-- <div id="selected_guard_global_html"></div> -->
                  <img id="selected_guard_global_svg" />
                </div>
                <!-- <img id="selected_guard_svg" /> -->
              <!-- </div> -->
            </div>
          </div>
        </div>
      </div>
    </div>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0-beta1/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-pprn3073KE6tl6bjs2QrFaJGz5/SUsLqktiwsUTF55Jfv3qYSDhgCecCxMW52nD2"
      crossorigin="anonymous"
    ></script>

    <div class="toast-container position-fixed bottom-0 end-0 p-3 text-body">
      <div id="errorToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header bg-danger bg-opacity-50 text-body">
          <!-- <img src="..." class="rounded me-2" alt="..."> -->
          <strong class="me-auto">Error</strong>
          <!-- <small>11 mins ago</small> -->
          <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body bg-danger bg-opacity-10 text-body">
          An error occured. Please try again.
        </div>
      </div>
    </div>
    <div class="modal fade" id="uploadLiveLogModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog">
          <div class="modal-content">
              <div class="modal-header">
                  <h5 class="modal-title">Load a Live Event Log</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <form id="live-event-log-form" method="post" action="/log/{{log_id}}/load-live-log" onsubmit="onSubmitLiveEventLogForm(event)"  enctype="multipart/form-data">
                  <div class="modal-body fs-5">
                      <label for="log" class="form-label">Select an event log (.xes)</label>
                      <input class="form-control form-control-lg" id="log" type="file" name="log" accept=".xes" required>
                  </div>
                  <div class="modal-footer">
                      <button class="btn btn-success" type="submit" diabled>Submit</button>
                  </div>
              </form>
          </div>
      </div>
  </div>
  </body>
</html>
